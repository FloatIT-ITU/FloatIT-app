rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user has ITU email domain
    function isITUEmail() {
      return isAuthenticated() &&
             request.auth.token.email.matches('.*@itu\\.dk$');
    }

    // Check if user is owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.admin == true;
    }

    // Check if user is event host
    function isEventHost(eventId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/events/$(eventId)) &&
             get(/databases/$(database)/documents/events/$(eventId)).data.host == request.auth.uid;
    }

    // ===== USERS COLLECTION =====
    // Private user data - only owner and admins can access

    match /users/{userId} {
      // Users can read/write their own private data
      allow read: if isOwner(userId);

      // Users can create their own document (during first sign-in)
      allow create: if isOwner(userId);

      // Users can update their own data (except admin field)
      allow update: if isOwner(userId) &&
        !('admin' in request.resource.data.diff(resource.data).affectedKeys());

      // Admins can read all user private data
      allow read: if isAdmin();
      
      // Admins can update any user data including admin field
      allow update: if isAdmin() && isITUEmail();
    }

    // ===== PUBLIC USERS COLLECTION =====
    // Public profile data - readable by all, writable by owner/admins

    match /public_users/{userId} {
      // Anyone can read public profiles
      allow read: if true;

      // Users can create their own public profile (during first sign-in)
      allow create: if isOwner(userId) && isITUEmail();

      // Users can update their own public profile
      allow update: if isOwner(userId) && isITUEmail();

      // Admins can also update public profiles
      allow update: if isAdmin() && isITUEmail();
    }

    // ===== EVENTS COLLECTION =====
    // Event data - readable by all, managed by admins and users for attendance

    match /events/{eventId} {
      // Anyone can read event details
      allow read: if true;

      // Only admins can create or delete events
      allow create, delete: if isAdmin() && isITUEmail();
      
      // Admins can update any fields
      allow update: if isAdmin() && isITUEmail();
      
      // Regular users can ONLY update attendees and waitingListUids (join/leave)
      allow update: if isAuthenticated() && isITUEmail() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees', 'waitingListUids']);
    }

    // ===== EVENT BANNERS =====
    // Event-specific notifications

    match /events/{eventId}/meta/event_banner {
      // Anyone can read event banners
      allow read: if true;

      // Event hosts and admins can create/update/delete event banners
      allow write: if isITUEmail() && (isEventHost(eventId) || isAdmin());
    }

    // ===== GLOBAL BANNER =====
    // App-wide notifications

    match /app/global_banner {
      // Anyone can read the global banner
      allow read: if true;

      // Only admins can manage the global banner
      allow write: if isAdmin() && isITUEmail();
    }

    // ===== TEMPLATES COLLECTION =====
    // Event templates for recurring events

    match /templates/{templateId} {
      // Anyone can read templates
      allow read: if true;

      // Only admins can manage templates
      allow write: if isAdmin() && isITUEmail();
    }

    // ===== JOIN REQUESTS COLLECTION =====
    // Queue for join/leave requests

    match /join_requests/{requestId} {
      // Users can create requests for themselves
      allow create: if isAuthenticated() && isITUEmail() &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.type in ['join', 'leave'] &&
        request.resource.data.eventId is string &&
        request.resource.data.createdAt is string;

      // Only admins can read requests (for processing)
      allow read: if isAdmin();
      
      // Only admins can delete processed requests
      allow delete: if isAdmin();
    }

    // ===== AUTH LOGS COLLECTION =====
    // Authentication logging

    match /auth_logs/{logId} {
      // System-managed logs - no direct write access
      allow write: if false;
      
      // Only admins can read logs
      allow read: if isAdmin();
    }

    // ===== POOL STATUS COLLECTION =====
    // Pool status data from external source

    match /pool_status/{document} {
      // Anyone can read pool status (public information)
      allow read: if true;

      // Only Cloud Functions can write (they run with admin privileges)
      allow write: if false;
    }

    // ===== MESSAGES COLLECTION =====
    // Private messaging threads between users

    match /messages/{threadId} {
      // Allow all operations for authenticated users
      // Security maintained by query filters and app logic
      allow read, write: if isAuthenticated();
    }

    // ===== USER EVENT HISTORY COLLECTION =====
    // Track user event participation for statistics

    match /user_event_history/{document} {
      // All authenticated users can read event history (needed for rankings)
      allow read: if isAuthenticated();

      // Users can write their own event history
      allow write: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Users can create their own event history records
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ===== DENY ALL OTHER ACCESS =====
    // Explicitly deny access to any collections not defined above

    match /{document=**} {
      allow read, write: if false;
    }
  }
}